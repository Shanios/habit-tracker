<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Habit Consistency Tracker</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f3f4f6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    .nav { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem 0; margin-bottom: 2rem; }
    .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .nav-title { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
    .nav-buttons { display: flex; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-active { background: #2563eb; color: white; }
    .btn-gray { background: #4b5563; color: white; }
    .btn-gray:hover { background: #374151; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
    .card-title { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; }
    .card-subtitle { color: #6b7280; margin-bottom: 1.5rem; }
    .input { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
    .input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .input-group { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .habit-item { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.75rem; transition: background 0.2s; }
    .habit-item:hover { background: #f9fafb; }
    .checkbox { width: 1.5rem; height: 1.5rem; border: 2px solid #d1d5db; border-radius: 0.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
    .checkbox:hover { border-color: #10b981; }
    .checkbox-checked { background: #10b981; border-color: #10b981; }
    .checkbox-icon { width: 1rem; height: 1rem; color: white; }
    .habit-title { flex: 1; color: #1f2937; }
    .habit-title-done { text-decoration: line-through; color: #9ca3af; }
    .icon-btn { background: none; border: none; cursor: pointer; color: #9ca3af; padding: 0.25rem; transition: color 0.2s; }
    .icon-btn:hover { color: #ef4444; }
    .empty-state { text-align: center; padding: 2rem; color: #6b7280; }
    .legend { display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem; color: #6b7280; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; }
    .legend-box { width: 0.75rem; height: 0.75rem; border-radius: 0.125rem; }
    .heatmap-container { overflow-x: auto; margin-bottom: 1rem; }
    .heatmap { display: inline-grid; gap: 2px; grid-template-rows: repeat(7, 12px); grid-auto-flow: column; grid-auto-columns: 12px; }
    .heatmap-cell { border-radius: 2px; cursor: pointer; transition: all 0.2s; }
    .heatmap-cell:hover { transform: scale(1.2); box-shadow: 0 0 0 2px #2563eb; }
    .color-0 { background: #e5e7eb; }
    .color-1 { background: #bbf7d0; }
    .color-2 { background: #4ade80; }
    .color-3 { background: #16a34a; }
    .tooltip { margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem; font-size: 0.875rem; }
    .settings-section { margin-bottom: 1.5rem; }
    .settings-title { font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .file-input { display: none; }
    svg { display: inline-block; vertical-align: middle; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext } = React;

    // ============ HOOKS ============

    const useStorage = (key, initialValue) => {
      const [value, setValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch {
          return initialValue;
        }
      });

      useEffect(() => {
        try {
          window.localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Storage error:', e);
        }
      }, [key, value]);

      return [value, setValue];
    };

    const useProfiles = () => {
      const [profiles, setProfiles] = useStorage('profiles', {});
      const [activeId, setActiveId] = useStorage('activeProfileId', 'default');

      useEffect(() => {
        if (!profiles[activeId]) {
          setProfiles(prev => ({
            ...prev,
            [activeId]: { habits: [], activity_logs: {} }
          }));
        }
      }, [activeId]);

      return { profiles, setProfiles, activeId, setActiveId };
    };

    const useHabits = (profileId, profiles, setProfiles) => {
      const habits = profiles[profileId]?.habits || [];

      const addHabit = (title) => {
        const newHabit = { id: Date.now().toString(), title };
        setProfiles(prev => ({
          ...prev,
          [profileId]: {
            ...prev[profileId],
            habits: [...(prev[profileId]?.habits || []), newHabit]
          }
        }));
      };

      const deleteHabit = (id) => {
        setProfiles(prev => ({
          ...prev,
          [profileId]: {
            ...prev[profileId],
            habits: prev[profileId].habits.filter(h => h.id !== id)
          }
        }));
      };

      return { habits, addHabit, deleteHabit };
    };

    const useLogs = (profileId, profiles, setProfiles) => {
      const logs = profiles[profileId]?.activity_logs || {};

      const toggleLog = (date, habitId) => {
        setProfiles(prev => {
          const currentLogs = prev[profileId]?.activity_logs || {};
          const dayLog = currentLogs[date] || {};
          const newDayLog = { ...dayLog };
          
          if (newDayLog[habitId]) {
            delete newDayLog[habitId];
          } else {
            newDayLog[habitId] = true;
          }

          return {
            ...prev,
            [profileId]: {
              ...prev[profileId],
              activity_logs: {
                ...currentLogs,
                [date]: newDayLog
              }
            }
          };
        });
      };

      const isComplete = (date, habitId) => {
        return logs[date]?.[habitId] || false;
      };

      return { logs, toggleLog, isComplete };
    };

    const useAnalytics = (logs) => {
      const getCompletionCount = (date) => {
        const dayLog = logs[date] || {};
        return Object.keys(dayLog).length;
      };

      const getCurrentStreak = () => {
        let streak = 0;
        const today = new Date();
        
        for (let i = 0; i < 365; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          
          if (getCompletionCount(dateStr) > 0) {
            streak++;
          } else if (i > 0) {
            break;
          }
        }
        return streak;
      };

      return { getCompletionCount, getCurrentStreak };
    };

    // ============ ICONS ============

    const Calendar = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const TrendingUp = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const Settings = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m0-6h6m-6 0H6"></path>
      </svg>
    );

    const Plus = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Trash2 = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const Check = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    // ============ CONTEXT ============

    const AppContext = createContext();

    const AppProvider = ({ children }) => {
      const { profiles, setProfiles, activeId } = useProfiles();
      const { habits, addHabit, deleteHabit } = useHabits(activeId, profiles, setProfiles);
      const { logs, toggleLog, isComplete } = useLogs(activeId, profiles, setProfiles);
      const analytics = useAnalytics(logs);

      return (
        <AppContext.Provider value={{
          habits, addHabit, deleteHabit,
          logs, toggleLog, isComplete,
          analytics, profiles, setProfiles
        }}>
          {children}
        </AppContext.Provider>
      );
    };

    const useApp = () => useContext(AppContext);

    // ============ PAGES ============

    const HabitApp = () => {
      const { habits, addHabit, deleteHabit, toggleLog, isComplete, analytics } = useApp();
      const [input, setInput] = useState('');
      const today = new Date().toISOString().split('T')[0];

      const handleAdd = () => {
        if (input.trim()) {
          addHabit(input.trim());
          setInput('');
        }
      };

      return (
        <div className="container">
          <div className="card">
            <div>
              <h2 className="card-title">Today's Habits</h2>
              <p className="card-subtitle">Current streak: {analytics.getCurrentStreak()} days</p>
            </div>

            <div className="input-group">
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleAdd()}
                placeholder="Add new habit..."
                className="input"
              />
              <button onClick={handleAdd} className="btn btn-primary">
                <Plus />
                Add
              </button>
            </div>

            <div>
              {habits.length === 0 ? (
                <p className="empty-state">No habits yet. Add one to get started!</p>
              ) : (
                habits.map(habit => (
                  <div key={habit.id} className="habit-item">
                    <div
                      onClick={() => toggleLog(today, habit.id)}
                      className={`checkbox ${isComplete(today, habit.id) ? 'checkbox-checked' : ''}`}
                    >
                      {isComplete(today, habit.id) && <Check />}
                    </div>
                    <span className={`habit-title ${isComplete(today, habit.id) ? 'habit-title-done' : ''}`}>
                      {habit.title}
                    </span>
                    <button onClick={() => deleteHabit(habit.id)} className="icon-btn">
                      <Trash2 />
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    };

    const Analytics = () => {
      const { logs, analytics } = useApp();
      const [hoveredDay, setHoveredDay] = useState(null);

      const days = [];
      const today = new Date();
      for (let i = 364; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        days.push(d);
      }

      const getColorClass = (count) => {
        if (count === 0) return 'color-0';
        if (count === 1) return 'color-1';
        if (count <= 3) return 'color-2';
        return 'color-3';
      };

      return (
        <div className="container">
          <div className="card">
            <h2 className="card-title">365-Day Consistency</h2>

            <div className="legend">
              <div className="legend-item">
                <div className="legend-box color-0"></div>
                <span>0 habits</span>
              </div>
              <div className="legend-item">
                <div className="legend-box color-1"></div>
                <span>1 habit</span>
              </div>
              <div className="legend-item">
                <div className="legend-box color-2"></div>
                <span>2-3 habits</span>
              </div>
              <div className="legend-item">
                <div className="legend-box color-3"></div>
                <span>4+ habits</span>
              </div>
            </div>

            <div className="heatmap-container">
              <div className="heatmap">
                {days.map((date, i) => {
                  const dateStr = date.toISOString().split('T')[0];
                  const count = analytics.getCompletionCount(dateStr);
                  const dayOfWeek = date.getDay();
                  
                  return (
                    <div
                      key={i}
                      className={`heatmap-cell ${getColorClass(count)}`}
                      style={{ gridRow: dayOfWeek + 1 }}
                      onMouseEnter={() => setHoveredDay({ date: dateStr, count })}
                      onMouseLeave={() => setHoveredDay(null)}
                      title={`${count} completions on ${dateStr}`}
                    />
                  );
                })}
              </div>
            </div>

            {hoveredDay && (
              <div className="tooltip">
                <strong>{hoveredDay.count}</strong> completions on <strong>{hoveredDay.date}</strong>
              </div>
            )}

            {analytics.getCompletionCount(today.toISOString().split('T')[0]) === 0 && (
              <p className="empty-state">
                Start completing habits to see your progress here
              </p>
            )}
          </div>
        </div>
      );
    };

    const SettingsPage = () => {
      const { profiles, setProfiles } = useApp();

      const exportData = () => {
        const data = JSON.stringify(profiles, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            setProfiles(data);
            alert('Data imported successfully!');
          } catch {
            alert('Invalid backup file');
          }
        };
        reader.readAsText(file);
      };

      return (
        <div className="container">
          <div className="card">
            <h2 className="card-title">Settings</h2>

            <div className="settings-section">
              <h3 className="settings-title">Backup & Restore</h3>
              <div style={{ display: 'flex', gap: '0.75rem' }}>
                <button onClick={exportData} className="btn btn-primary">
                  Export Data
                </button>
                <label className="btn btn-gray">
                  Import Data
                  <input
                    type="file"
                    accept=".json"
                    onChange={importData}
                    className="file-input"
                  />
                </label>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============ APP ============

    const App = () => {
      const [page, setPage] = useState('habits');

      return (
        <AppProvider>
          <div>
            <nav className="nav">
              <div className="nav-content">
                <h1 className="nav-title">Habit Tracker</h1>
                <div className="nav-buttons">
                  <button
                    onClick={() => setPage('habits')}
                    className={`btn ${page === 'habits' ? 'btn-active' : 'btn-secondary'}`}
                  >
                    <Calendar />
                    Habits
                  </button>
                  <button
                    onClick={() => setPage('analytics')}
                    className={`btn ${page === 'analytics' ? 'btn-active' : 'btn-secondary'}`}
                  >
                    <TrendingUp />
                    Analytics
                  </button>
                  <button
                    onClick={() => setPage('settings')}
                    className={`btn ${page === 'settings' ? 'btn-active' : 'btn-secondary'}`}
                  >
                    <Settings />
                    Settings
                  </button>
                </div>
              </div>
            </nav>

            <main>
              {page === 'habits' && <HabitApp />}
              {page === 'analytics' && <Analytics />}
              {page === 'settings' && <SettingsPage />}
            </main>
          </div>
        </AppProvider>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
